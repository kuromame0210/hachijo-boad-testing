以下は、**Codex にそのまま貼って技術検証を進められる前提**で、「今こうすれば取得できる」を**指示文として**まとめたものです（コードは書かない／ただし手順と要件は全部明記）。

---

## 目的

八丈町のWebサイトで、以下2系統の運行情報を**5分ごとに自動取得**し、**出典表示付きで公開**できることを技術検証する。

1. **ANA（羽田⇄八丈島）**：運航状況・遅延・出発/到着の予定・見込み
2. **東海汽船（東京⇄八丈島・大型客船）**：就航/欠航・遅延（数値）・出発予定・到着予定（＋取れれば見込み/入出港地）

共通条件：

* 公開表示の内容は「公式表示と一致」が必須（ANAはANA公式運航状況相当、東海汽船は東海汽船公式表示）
* 更新間隔：5分（ただし取得元が更新しない時間帯があっても、取得自体は5分で行う）
* 出典表示は必須
* 実機位置は必須ではない（取れるなら別途）

---

# A) ANA（羽田⇄八丈島）取得方針（結論：ODPT APIを使う）

## 取得元（正の情報源）

* 公共交通オープンデータセンター（ODPT）の **ANAフライト情報API** を使う

  * 出発：`odpt:FlightInformationDeparture`
  * 到着：`odpt:FlightInformationArrival`
* 取得には **ODPTのAPIキー（consumerKey）** が必要

※この方式は「Webスクレイピング」ではなく「公開API」で、5分ポーリング運用に向く。

## 対象便（固定）

* **HND→HAC**：ANA1891 / ANA1893 / ANA1895
* **HAC→HND**：ANA1892 / ANA1894 / ANA1896

便番号でフィルタして6便だけを扱う（便番号の探索は不要）。

## 取得する項目（表示要件）

* 遅延
* 出発予定時刻
* 到着予定時刻
* 出発見込み時刻（ある場合）
* 到着見込み時刻（ある場合）
* ステータス（出発済/到着済/欠航など）

※「公式と一致」が必須なので、ODPTの値がANA公式運航状況表示と整合するか（少なくとも主要項目）を検証する。

## 検証手順（Codexがやるべきこと）

1. ODPTの開発者登録を前提として、APIキーを環境変数として受け取れるようにする（例：`ODPT_CONSUMER_KEY`）。
2. 5分間隔で以下2エンドポイントを取得できることを確認する：

   * Departure（ANA）：`odpt:FlightInformationDeparture` を operator=ANA で取得
   * Arrival（ANA）：`odpt:FlightInformationArrival` を operator=ANA で取得
3. レスポンスから `odpt:flightNumber` 等で **1891〜1896の6便のみ抽出**できること。
4. 抽出した結果から、表示要件（遅延、予定、見込み、ステータス）に必要なフィールドが取れることを確認する。
5. 同日時点のANA公式運航状況ページ（人手確認でOK）と主要項目が一致することを確認する（一致要件の担保）。

## 出典表示（UIに必要）

* 「データ提供：公共交通オープンデータセンター（ODPT）/ 全日空」等を表示する。

---

# B) 東海汽船（東京⇄八丈島・大型客船）取得方針（結論：公式ページ併用）

## 取得元（正の情報源）

東海汽船は「公式APIが明確に公開されている前提に置かない」。
その代わり **公式サイトの表示をそのまま取得**する。

### 正の情報源は2つに分ける（役割分担）

1. **本日の運航状況（公式）**

   * 取得対象：八丈島関連のセクション
   * ここから取る：

     * 就航/欠航
     * 遅延（数値が表示される場合）
     * 出発予定時刻（出航時刻として表示される）
     * 見込み時刻（表示される場合）
     * 入出港地（出帆港として表示される場合：底土/八重根等）

2. **時刻表（公式：乗船日検索のダイヤ）**

   * ここから取る：

     * **到着予定時刻（必須）**
       ※運航状況ページは「到着時刻は時刻表を確認」としている構造なので、到着予定は時刻表を正とする。

## 対象範囲（固定）

* **東京→八丈島** と **八丈島→東京** の往復を **別枠表示**する。
* 「昨晩東京発→今朝八丈島着」のような便も、公式運航状況に載っていれば **本日の対象として表示**する。

## 取得する項目（表示要件）

必須：

* 就航 / 欠航
* 遅延（数値が公式に出る前提。出ない日は非表示または「情報なし」）
* 出発予定時刻
* 到着予定時刻（時刻表から）

任意（取れるなら）：

* 見込み時刻
* 入出港地（底土港 / 八重根港）

## 検証手順（Codexがやるべきこと）

1. 5分ごとに「本日の運航状況」ページを取得し、八丈島関連の行を抽出できること。

   * 船種が「大型客船」の行だけに絞れること。
   * 東京→八丈島、八丈島→東京を分けて抽出できること。
2. 抽出行から「就航/欠航」「出航時刻」「（あれば）遅延数値」「（あれば）備考の見込み」「（あれば）出帆港」を取り出せること。
3. 別途「時刻表（乗船日検索）」から、同日・同航路の **到着予定時刻** を取得し、運航状況側の該当便に紐づけられること。

   * 便名や船名など、公式ページ上の識別子で結合する（具体のキーはページ構造次第なので、検証で確定する）。
4. 「公式ページ表示と一致」要件のため、抽出値がそのまま表示できる形（＝公式文字列と一致）で保持できること。
5. 遅延数値が出ない日は、その項目を非表示または「情報なし」にできること（仕様どおり）。

## 出典表示（UIに必要）

* 「出典：東海汽船 公式サイト（本日の運航状況・時刻表）」を表示する。
* もしODPTのGTFS等を補助で使う場合は「ODPT」も併記する（ただし、公式一致要件上は補助扱い）。

---

# 共通：実装方式（技術検証のゴール）

* フロントは直接取得しない（キー保護・負荷・運用のため）。
* サーバ側で5分ごとに取得して保存し、サイトは保存済みデータを表示する構成が前提。
* 表示には「最終更新時刻」を必ず出す。
* 取得失敗時は直近の成功データを表示し、更新停止が分かるようにする。

---

## Codexに渡す“検証完了条件”

* ANA：ODPTから6便が抽出でき、表示要件（遅延・予定・見込み・ステータス）が揃う。
* 東海汽船：運航状況から就航/欠航/出発予定（＋遅延が出る日）を取得でき、時刻表から到着予定を取得して結合できる。
* 両方：5分更新の自動取得が可能で、出典表示を含む公開表示仕様が成立する。

---

必要なら、この文章を「Codex用の命令形（チェックリスト形式）」にさらに圧縮して、貼った瞬間にタスク分解が始まる形に整えます。
